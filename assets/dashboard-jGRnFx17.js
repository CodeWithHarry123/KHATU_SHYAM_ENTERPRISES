import{o as U,d as O,b as w,g as V,s as D,a as v,q as _,c as z,w as j,e as F,f as G}from"./firebase-init-CdBNjGdT.js";/* empty css              */import{E as K}from"./error-handler-C6QH1pGL.js";document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("bookings-table-body"),d=document.getElementById("bookings-card-view");function L(){if(!i||!d)return;const t=`
            <tr>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-3/4"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-1/2"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-full"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-20 h-6 rounded-full"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-1/2"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-24 h-6"></div></td>
            </tr>
        `.repeat(5),e=`
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-3">
                <div class="flex justify-between items-start">
                    <div class="skeleton skeleton-text w-1/4"></div>
                    <div class="skeleton skeleton-text w-20 h-6 rounded-full"></div>
                </div>
                <div class="space-y-2">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-1/2"></div>
                </div>
                <div class="skeleton skeleton-text w-1/3 mt-2"></div>
            </div>
        `.repeat(4);i.innerHTML=t,d.innerHTML=e}let p=[],g="All",m="";const E=document.getElementById("logout-button"),B=document.getElementById("mobile-menu-button"),$=document.getElementById("mobile-menu"),x=document.getElementById("mobile-logout-button"),I=document.getElementById("search-input"),A=document.getElementById("filter-buttons");U(v,async t=>{if(!t){window.location.href="login.html";return}L();try{const e=O(w,"users",t.uid),s=await V(e);if(!s.exists()){alert("User data not found. Please contact support."),await D(v),window.location.href="login.html";return}const n=s.data();if(n.khatu_website_admin===!0){window.location.href="admin_dashboard.html";return}if(!n.name||!n.address){const a=document.getElementById("profile-update-modal");a&&(a.classList.remove("hidden"),a.classList.add("flex"))}await M(t.uid)}catch(e){console.error("Error during auth state change: ",e)}});async function M(t){try{const e=_(z(w,"bookings"),j("userId","==",t),F("bookingDate","desc")),s=await G(e);p=[],s.forEach(n=>{p.push({id:n.id,...n.data()})}),u()}catch(e){console.error("Error loading bookings: ",e);const s='<div class="text-center py-10 text-red-500 col-span-full">Error loading bookings.</div>';i.innerHTML='<tr><td colspan="6" class="text-center py-10 text-red-500">Error loading bookings.</td></tr>',d.innerHTML=s,K.show(e.message,"error")}}function u(){let t=[...p];if(g!=="All"&&(t=t.filter(e=>e.status===g)),m){const e=m.toLowerCase();t=t.filter(s=>s.bookingId&&s.bookingId.toLowerCase().includes(e)||s.receiverDetails&&s.receiverDetails.address&&s.receiverDetails.address.toLowerCase().includes(e)||s.receiverDetails&&s.receiverDetails.pincode&&s.receiverDetails.pincode.toLowerCase().includes(e))}C(t)}function C(t){if(i.innerHTML="",d.innerHTML="",t.length===0){const e='<div class="text-center py-10 col-span-full">No bookings match your criteria.</div>';i.innerHTML='<tr><td colspan="6" class="text-center py-10">No bookings match your criteria.</td></tr>',d.innerHTML=e;return}t.forEach(e=>{const s=e.bookingDate?e.bookingDate.toDate().toLocaleDateString():"Processing...",n=N(e.status),a=e.receiverDetails&&e.receiverDetails.address?`${e.receiverDetails.address}, ${e.receiverDetails.pincode||""}`:"N/A";let o="";const c=e.paymentStatus||"N/A";switch(c.toLowerCase()){case"paid":o='<span class="font-medium text-green-500">Paid</span>';break;case"cos":o='<span class="font-medium text-green-500">Cash on Shipping</span>';break;case"pending":o=`<button class="repay-btn font-medium text-yellow-500 hover:underline cursor-pointer" data-booking-id="${e.bookingId}" data-amount="${e.amount||0}">Pending</button>`;break;default:o=`<span class="font-medium text-gray-500">${c.charAt(0).toUpperCase()+c.slice(1)}</span>`}const y=`
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${e.bookingId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${s}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${a}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${n}">${e.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${o}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><a class="view-details-btn text-primary hover:text-primary-dark dark:text-secondary dark:hover:text-secondary-light flex items-center gap-1" href="#" data-booking-id="${e.id}">View Details <span class="material-symbols-outlined text-lg">visibility</span></a></td>
                </tr>`;i.innerHTML+=y;const R=`
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-primary dark:text-secondary text-sm">${e.bookingId}</div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${n}">${e.status}</span>
                    </div>
                    <div class="text-sm">
                        <p class="text-gray-600 dark:text-gray-300">To: ${a}</p>
                        <p class="text-gray-600 dark:text-gray-300">Payment: ${o}</p>
                    </div>
                    <div class="text-xs text-gray-400 dark:text-gray-500 pt-2 border-t border-gray-200 dark:border-gray-700">Booked on: ${s}</div>
                    <a class="view-details-btn text-primary hover:text-primary-dark dark:text-secondary dark:hover:text-secondary-light flex items-center gap-1 text-sm font-medium pt-2" href="#" data-booking-id="${e.id}">View Details <span class="material-symbols-outlined text-base">visibility</span></a>
                </div>`;d.innerHTML+=R})}function N(t){switch(t){case"Delivered":return"bg-delivered/20 text-delivered";case"In Transit":return"bg-in-transit/20 text-in-transit";case"Booked":default:return"bg-booked/20 text-booked"}}const T="123123xxx42@axl",S="Khatu Shyam Enterprises",r=document.getElementById("repayment-qr-modal"),f=document.getElementById("repayment-modal-close-button");document.body.addEventListener("click",function(t){const e=t.target.closest(".repay-btn");if(e){t.preventDefault();const n=e.dataset.bookingId,a=e.dataset.amount;if(!n||!a||a==="0")return;const o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),c=`upi://pay?pa=${T}&pn=${encodeURIComponent(S)}&am=${a}&cu=INR&tn=${n}`;if(o)window.location.href=c;else{const y=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(c)}`;document.getElementById("repayment-qr-container").innerHTML=`<img src="${y}" alt="UPI QR Code">`,document.getElementById("repayment-booking-id").textContent=n,document.getElementById("repayment-amount").textContent=a,r.classList.remove("hidden"),r.classList.add("flex")}}const s=t.target.closest(".view-details-btn");if(s){t.preventDefault();const n=s.dataset.bookingId;q(n)}}),f&&f.addEventListener("click",()=>r.classList.add("hidden")),r&&r.addEventListener("click",t=>{t.target===r&&r.classList.add("hidden")});const l=document.getElementById("booking-modal"),b=document.getElementById("modal-content"),H=document.getElementById("modal-body"),P=document.getElementById("modal-close-button");function q(t){const e=p.find(n=>n.id===t);if(!e)return;let s="N/A";if(e.bookingDate)if(typeof e.bookingDate.toDate=="function")s=e.bookingDate.toDate().toLocaleString();else try{s=new Date(e.bookingDate).toLocaleString()}catch{s="Invalid Date"}H.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Sender Details</h3><p><strong>Name:</strong> ${e.senderDetails?.name??"N/A"}</p><p><strong>Mobile:</strong> ${e.senderDetails?.mobile??"N/A"}</p><p><strong>Pincode:</strong> ${e.senderDetails?.pincode??"N/A"}</p><p><strong>Address:</strong> ${e.senderDetails?.address??"N/A"}</p></div>
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Receiver Details</h3><p><strong>Name:</strong> ${e.receiverDetails?.name??"N/A"}</p><p><strong>Mobile:</strong> ${e.receiverDetails?.mobile??"N/A"}</p><p><strong>Pincode:</strong> ${e.receiverDetails?.pincode??"N/A"}</p><p><strong>Address:</strong> ${e.receiverDetails?.address??"N/A"}</p></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Parcel Details</h3><p><strong>Weight:</strong> ${e.parcelDetails?.weight??"N/A"} kg</p><p><strong>Size:</strong> ${e.parcelDetails?.size??"N/A"}</p><p><strong>Type:</strong> ${e.parcelDetails?.type??"N/A"}</p></div>
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Booking Info</h3><p><strong>Booking ID:</strong> ${e.bookingId??"N/A"}</p><p><strong>Price (incl. GST):</strong> â‚¹${e.amount??"N/A"}</p><p><strong>Status:</strong> ${e.status??"N/A"}</p><p><strong>Date:</strong> ${s}</p></div>
            </div>`,l.classList.remove("hidden"),l.classList.add("flex"),setTimeout(()=>b.classList.remove("scale-95"),50)}function h(){b.classList.add("scale-95"),setTimeout(()=>{l.classList.add("hidden"),l.classList.remove("flex")},300)}function k(){D(v).then(()=>{window.location.href="index.html"})}E.addEventListener("click",k),x&&x.addEventListener("click",k),B.addEventListener("click",()=>$.classList.toggle("hidden")),A.addEventListener("click",t=>{const e=t.target.closest(".filter-btn");e&&(g=e.dataset.filter,document.querySelectorAll(".filter-btn").forEach(s=>{s.classList.remove("bg-primary","text-white"),s.classList.add("bg-white","dark:bg-gray-800","text-gray-800","dark:text-gray-200")}),e.classList.add("bg-primary","text-white"),e.classList.remove("bg-white","dark:bg-gray-800","text-gray-800","dark:text-gray-200"),u())}),I.addEventListener("input",t=>{m=t.target.value,u()}),P.addEventListener("click",h),l.addEventListener("click",t=>{t.target===l&&h()})});
