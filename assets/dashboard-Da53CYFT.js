import{o as R,d as U,b as w,g as O,s as L,a as x,q as V,c as _,w as j,e as F,f as z}from"./firebase-init-C-AE0vWN.js";/* empty css              */document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("bookings-table-body"),d=document.getElementById("bookings-card-view");function D(){if(!r||!d)return;const t=`
            <tr>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-3/4"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-1/2"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-full"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-20 h-6 rounded-full"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-1/2"></div></td>
                <td class="px-6 py-4"><div class="skeleton skeleton-text w-24 h-6"></div></td>
            </tr>
        `.repeat(5),e=`
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-3">
                <div class="flex justify-between items-start">
                    <div class="skeleton skeleton-text w-1/4"></div>
                    <div class="skeleton skeleton-text w-20 h-6 rounded-full"></div>
                </div>
                <div class="space-y-2">
                    <div class="skeleton skeleton-text w-full"></div>
                    <div class="skeleton skeleton-text w-1/2"></div>
                </div>
                <div class="skeleton skeleton-text w-1/3 mt-2"></div>
            </div>
        `.repeat(4);r.innerHTML=t,d.innerHTML=e}let c=[],g="All",m="";const E=document.getElementById("logout-button"),B=document.getElementById("mobile-menu-button"),I=document.getElementById("mobile-menu"),v=document.getElementById("mobile-logout-button"),$=document.getElementById("search-input"),M=document.getElementById("filter-buttons");R(x,async t=>{if(!t){window.location.href="login.html";return}D();try{const e=U(w,"users",t.uid),s=await O(e);if(!s.exists()){alert("User data not found. Please contact support."),await L(x),window.location.href="login.html";return}const n=s.data();if(n.khatu_website_admin===!0){window.location.href="admin_dashboard.html";return}if(!n.name||!n.address){const a=document.getElementById("profile-update-modal");a&&(a.classList.remove("hidden"),a.classList.add("flex"))}await C(t.uid)}catch(e){console.error("Error during auth state change: ",e)}});async function C(t){try{const e=V(_(w,"bookings"),j("userId","==",t),F("bookingDate","desc")),s=await z(e);c=[],s.forEach(n=>{c.push({id:n.id,...n.data()})}),u()}catch(e){console.error("Error loading bookings: ",e);const s='<div class="text-center py-10 text-red-500 col-span-full">Error loading bookings.</div>';r.innerHTML='<tr><td colspan="6" class="text-center py-10 text-red-500">Error loading bookings.</td></tr>',d.innerHTML=s,ErrorHandler.show(e.message,"error")}}function u(){let t=[...c];if(g!=="All"&&(t=t.filter(e=>e.status===g)),m){const e=m.toLowerCase();t=t.filter(s=>s.bookingId&&s.bookingId.toLowerCase().includes(e)||s.receiverDetails.address&&s.receiverDetails.address.toLowerCase().includes(e)||s.receiverDetails.pincode&&s.receiverDetails.pincode.toLowerCase().includes(e))}T(t)}function T(t){if(r.innerHTML="",d.innerHTML="",t.length===0){const e='<div class="text-center py-10 col-span-full">No bookings match your criteria.</div>';r.innerHTML='<tr><td colspan="6" class="text-center py-10">No bookings match your criteria.</td></tr>',d.innerHTML=e;return}t.forEach(e=>{const s=e.bookingDate?e.bookingDate.toDate().toLocaleDateString():"Processing...",n=S(e.status);let a="";const l=e.paymentStatus||"N/A";switch(l.toLowerCase()){case"paid":a='<span class="font-medium text-green-500">Paid</span>';break;case"cos":a='<span class="font-medium text-green-500">Cash on Shipping</span>';break;case"pending":a=`<button class="repay-btn font-medium text-yellow-500 hover:underline cursor-pointer" data-booking-id="${e.bookingId}" data-amount="${e.amount||0}">Pending</button>`;break;default:a=`<span class="font-medium text-gray-500">${l.charAt(0).toUpperCase()+l.slice(1)}</span>`}const p=`
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${e.bookingId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${s}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${e.receiverDetails.address}, ${e.receiverDetails.pincode}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${n}">${e.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${a}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><a class="view-details-btn text-primary hover:text-primary-dark dark:text-secondary dark:hover:text-secondary-light flex items-center gap-1" href="#" data-booking-id="${e.id}">View Details <span class="material-symbols-outlined text-lg">visibility</span></a></td>
                </tr>`;r.innerHTML+=p;const y=`
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-primary dark:text-secondary text-sm">${e.bookingId}</div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${n}">${e.status}</span>
                    </div>
                    <div class="text-sm">
                        <p class="text-gray-600 dark:text-gray-300">To: ${e.receiverDetails.address}, ${e.receiverDetails.pincode}</p>
                        <p class="text-gray-600 dark:text-gray-300">Payment: ${a}</p>
                    </div>
                    <div class="text-xs text-gray-400 dark:text-gray-500 pt-2 border-t border-gray-200 dark:border-gray-700">Booked on: ${s}</div>
                    <a class="view-details-btn text-primary hover:text-primary-dark dark:text-secondary dark:hover:text-secondary-light flex items-center gap-1 text-sm font-medium pt-2" href="#" data-booking-id="${e.id}">View Details <span class="material-symbols-outlined text-base">visibility</span></a>
                </div>`;d.innerHTML+=y})}function S(t){switch(t){case"Delivered":return"bg-delivered/20 text-delivered";case"In Transit":return"bg-in-transit/20 text-in-transit";case"Booked":default:return"bg-booked/20 text-booked"}}const H="123123xxx42@axl",A="Khatu Shyam Enterprises",o=document.getElementById("repayment-qr-modal"),b=document.getElementById("repayment-modal-close-button");document.body.addEventListener("click",function(t){const e=t.target.closest(".repay-btn");if(e){t.preventDefault();const n=e.dataset.bookingId,a=e.dataset.amount;if(!n||!a||a==="0")return;const l=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),p=`upi://pay?pa=${H}&pn=${encodeURIComponent(A)}&am=${a}&cu=INR&tn=${n}`;if(l)window.location.href=p;else{const y=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(p)}`;document.getElementById("repayment-qr-container").innerHTML=`<img src="${y}" alt="UPI QR Code">`,document.getElementById("repayment-booking-id").textContent=n,document.getElementById("repayment-amount").textContent=a,o.classList.remove("hidden"),o.classList.add("flex")}}const s=t.target.closest(".view-details-btn");if(s){t.preventDefault();const n=s.dataset.bookingId;N(n)}}),b&&b.addEventListener("click",()=>o.classList.add("hidden")),o&&o.addEventListener("click",t=>{t.target===o&&o.classList.add("hidden")});const i=document.getElementById("booking-modal"),f=document.getElementById("modal-content"),P=document.getElementById("modal-body"),q=document.getElementById("modal-close-button");function N(t){const e=c.find(n=>n.id===t);if(!e)return;const s=e.bookingDate?e.bookingDate.toDate().toLocaleString():"N/A";P.innerHTML=`
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Sender Details</h3><p><strong>Name:</strong> ${e.senderDetails.name}</p><p><strong>Mobile:</strong> ${e.senderDetails.mobile}</p><p><strong>Pincode:</strong> ${e.senderDetails.pincode}</p><p><strong>Address:</strong> ${e.senderDetails.address}</p></div>
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Receiver Details</h3><p><strong>Name:</strong> ${e.receiverDetails.name}</p><p><strong>Mobile:</strong> ${e.receiverDetails.mobile}</p><p><strong>Pincode:</strong> ${e.receiverDetails.pincode}</p><p><strong>Address:</strong> ${e.receiverDetails.address}</p></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Parcel Details</h3><p><strong>Weight:</strong> ${e.parcelDetails.weight} kg</p><p><strong>Type:</strong> ${e.parcelDetails.type}</p></div>
                <div class="space-y-2"><h3 class="font-bold text-lg border-b pb-1">Booking Info</h3><p><strong>Booking ID:</strong> ${e.bookingId}</p><p><strong>Status:</strong> ${e.status}</p><p><strong>Date:</strong> ${s}</p></div>
            </div>`,i.classList.remove("hidden"),i.classList.add("flex"),setTimeout(()=>f.classList.remove("scale-95"),50)}function h(){f.classList.add("scale-95"),setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("flex")},300)}function k(){L(x).then(()=>{window.location.href="index.html"})}E.addEventListener("click",k),v&&v.addEventListener("click",k),B.addEventListener("click",()=>I.classList.toggle("hidden")),M.addEventListener("click",t=>{const e=t.target.closest(".filter-btn");e&&(g=e.dataset.filter,document.querySelectorAll(".filter-btn").forEach(s=>{s.classList.remove("bg-primary","text-white"),s.classList.add("bg-white","dark:bg-gray-800","text-gray-800","dark:text-gray-200")}),e.classList.add("bg-primary","text-white"),e.classList.remove("bg-white","dark:bg-gray-800","text-gray-800","dark:text-gray-200"),u())}),$.addEventListener("input",t=>{m=t.target.value,u()}),q.addEventListener("click",h),i.addEventListener("click",t=>{t.target===i&&h()})});
