import{o as S,d as N,b as M,g as F,a as L,h as $,c as H,i as x}from"./firebase-init-CdBNjGdT.js";/* empty css              */import{E as l}from"./error-handler-C6QH1pGL.js";class f{static sanitizeHTML(t){const r=document.createElement("div");return r.textContent=t,r.innerHTML}static validateEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}static validatePhone(t){return/^[6-9]\d{9}$/.test(t)}static validatePincode(t){return/^[1-9][0-9]{5}$/.test(t)}static sanitizeInput(t){return typeof t!="string"?t:t.trim().replace(/[<>"']/g,"").substring(0,500)}}class A{constructor(){this.razorpayKey="rzp_test_RYFI1lMqR1SvDA"}async initiatePayment(t){showToast("Initializing payment...","info");{showToast("Payment gateway is not configured. Please contact support.","error"),console.error("Cloud function URL for Razorpay is not set.");return}}}class W{constructor(){this.baseRate=50,this.perKmRate=8,this.weightCharges={"0-5":0,"5-10":50,"10-20":100,"20+":200}}async calculatePrice(t,r,d){try{const o=await this.getDistance(t,r);if(o===null)return null;let s=this.baseRate+o*this.perKmRate;s+=this.getWeightCharge(d);const u=s*.18,m=s+u;return{basePrice:s.toFixed(2),gst:u.toFixed(2),total:m.toFixed(2),distance:o.toFixed(2)}}catch(o){return console.error("Price calculation error:",o),null}}async getDistance(t,r){try{const d=new google.maps.DirectionsService;return new Promise((o,s)=>{const u={origin:t,destination:r,travelMode:google.maps.TravelMode.DRIVING};d.route(u,function(m,g){if(g=="OK"){const h=m.routes[0].legs[0];o(h.distance.value/1e3)}else console.error("Directions Service failed with status:",g),s("Distance calculation failed. Please check the PIN codes.")})})}catch(d){console.error("Google Maps API failed, using fallback calculation:",d);const o=parseInt(t,10),s=parseInt(r,10),m=Math.abs(o-s)/100;return Promise.resolve(m)}}getWeightCharge(t){return t<=5?this.weightCharges["0-5"]:t<=10?this.weightCharges["5-10"]:t<=20?this.weightCharges["10-20"]:this.weightCharges["20+"]}}class G{constructor(t=10,r=6e4){this.maxRequests=t,this.timeWindow=r,this.requests=new Map}isAllowed(t){const r=Date.now(),o=(this.requests.get(t)||[]).filter(s=>r-s<this.timeWindow);return o.length>=this.maxRequests?!1:(o.push(r),this.requests.set(t,o),!0)}handleRequest(t,r){return this.isAllowed(t)?(r(),!0):(typeof ErrorHandler<"u"&&ErrorHandler.show?ErrorHandler.show("Too many requests. Please wait a moment.","warning"):alert("Too many requests. Please wait a moment."),!1)}}let C=100;document.addEventListener("DOMContentLoaded",()=>{const p=new W,t=new A,r=new G(5,6e4);S(L,async n=>{if(n)try{const e=N(M,"users",n.uid),a=await F(e);if(a.exists()){const i=a.data();document.getElementById("sender-name").value=i.name||"",n.phoneNumber&&(document.getElementById("sender-mobile").value=n.phoneNumber.startsWith("+91")?n.phoneNumber.slice(3):n.phoneNumber),document.getElementById("sender-address").value=i.address||"",document.getElementById("sender-pincode").value=i.pincode||""}}catch(e){l.handleFirebaseError(e)}else l.show("You must be logged in to book a parcel.","error"),setTimeout(()=>{window.location.href="login.html"},2e3)});const d=document.getElementById("sender-name"),o=document.getElementById("receiver-name");function s(n){const e=/[^\p{L}\s,]/gu;n.target.value=n.target.value.replace(e,"")}d&&d.addEventListener("input",s),o&&o.addEventListener("input",s);const u=document.getElementById("sender-mobile"),m=document.getElementById("receiver-mobile");function g(n){let e=n.target.value.replace(/[^0-9]/g,"");e=e.slice(0,10),n.target.value=e}u&&u.addEventListener("input",g),m&&m.addEventListener("input",g);const h=document.getElementById("sender-pincode"),y=document.getElementById("receiver-pincode");function w(n){let e=n.target.value.replace(/[^0-9]/g,"");e=e.slice(0,6),n.target.value=e}h&&h.addEventListener("input",w),y&&y.addEventListener("input",w);const I=document.getElementById("parcel-size");function T(n){let e=n.target.value;e=e.replace(/[ .,]/g,"×"),e=e.replace(/[^0-9×]/g,""),e=e.replace(/×+/g,"×");let a=e.split("×");a=a.map(i=>i.slice(0,2)),a.length>3&&(a=a.slice(0,3)),n.target.value=a.join("×")}I&&I.addEventListener("input",T),document.getElementById("calculate-price-button").addEventListener("click",async()=>{if(!p){l.show("Price calculator is not ready yet. Please wait a moment for Google Maps to load.","warning");return}const n=document.getElementById("sender-pincode").value,e=document.getElementById("receiver-pincode").value,a=parseFloat(document.getElementById("parcel-weight").value);if(!n||!e||!a){l.show("Please enter Sender & Receiver PIN codes and Parcel Weight to calculate the price.","warning");return}const i=document.getElementById("price-breakdown");i.innerHTML="Calculating...";try{const c=await p.calculatePrice(n,e,a);c&&c.total?(i.innerHTML=`
                    <p>Distance: ${c.distance} km</p>
                    <p>Base Price: ₹${c.basePrice}</p>
                    <p>GST (18%): ₹${c.gst}</p>
                    <h4 class="font-bold">Total: ₹${c.total}</h4>
                `,C=parseFloat(c.total)):(i.innerHTML="Could not calculate price.",l.show("Could not calculate price. Please check PIN codes.","error"))}catch(c){i.innerHTML="Error in price calculation.",l.show(c.message||"An error occurred during price calculation.","error")}}),document.getElementById("booking-form").addEventListener("submit",function(n){n.preventDefault();const e=L.currentUser;if(!e){l.show("You must be logged in to book a parcel.","error");return}r.handleRequest(e.uid,async()=>{const a=f.sanitizeInput(document.getElementById("sender-name").value),i=document.getElementById("sender-mobile").value,c=f.sanitizeInput(document.getElementById("sender-address").value),b=document.getElementById("sender-pincode").value,P=f.sanitizeInput(document.getElementById("receiver-name").value),B=document.getElementById("receiver-mobile").value,k=f.sanitizeInput(document.getElementById("receiver-address").value),R=document.getElementById("receiver-pincode").value,D=parseFloat(document.getElementById("parcel-weight").value),q=document.getElementById("parcel-size").value,z=document.getElementById("parcel-type").value;if(!a||!i||!c||!b||!P||!B||!k||!R||!D){l.show("Please fill out all required fields before submitting.","warning");return}const v={userId:e.uid,bookingId:`KS-${Date.now()}`,senderDetails:{name:a,mobile:i,address:c,pincode:b},receiverDetails:{name:P,mobile:B,address:k,pincode:R},parcelDetails:{weight:D,size:q,type:z},bookingDate:$(),status:"Booked",amount:C,paymentMethod:document.querySelector('input[name="payment"]:checked').value,paymentStatus:"pending"};v.paymentMethod==="online"?await t.initiatePayment(v,E):(v.paymentStatus="cos",await E(v))})});async function E(n){try{const e=H(M,"bookings"),a=await x(e,n);l.show(`Booking successful! Your Booking ID is ${n.bookingId}`,"success"),setTimeout(()=>{window.location.href="dashboard.html"},3e3)}catch(e){l.handleFirebaseError(e)}}});
