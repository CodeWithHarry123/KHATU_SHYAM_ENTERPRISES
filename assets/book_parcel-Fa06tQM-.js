import{o as g,d as p,b as u,g as w,a as m,h as y,c as f,i as v}from"./firebase-init-C-AE0vWN.js";/* empty css              */class b{static sanitizeHTML(e){const a=document.createElement("div");return a.textContent=e,a.innerHTML}static validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static validatePhone(e){return/^[6-9]\d{9}$/.test(e)}static validatePincode(e){return/^[1-9][0-9]{5}$/.test(e)}static sanitizeInput(e){return typeof e!="string"?e:e.trim().replace(/[<>"']/g,"").substring(0,500)}}class P{constructor(){this.razorpayKey="rzp_test_RYFI1lMqR1SvDA"}async initiatePayment(e){showToast("Initializing payment...","info");{showToast("Payment gateway is not configured. Please contact support.","error"),console.error("Cloud function URL for Razorpay is not set.");return}}}class I{constructor(){this.baseRate=50,this.perKmRate=8,this.weightCharges={"0-5":0,"5-10":50,"10-20":100,"20+":200}}async calculatePrice(e,a,s){try{const r=await this.getDistance(e,a);if(r===null)return null;let t=this.baseRate+r*this.perKmRate;t+=this.getWeightCharge(s);const n=t*.18,i=t+n;return{basePrice:t.toFixed(2),gst:n.toFixed(2),total:i.toFixed(2),distance:r.toFixed(2)}}catch(r){return console.error("Price calculation error:",r),null}}async getDistance(e,a){try{const s=new google.maps.DirectionsService;return new Promise((r,t)=>{const n={origin:e,destination:a,travelMode:google.maps.TravelMode.DRIVING};s.route(n,function(i,c){if(c=="OK"){const o=i.routes[0].legs[0];r(o.distance.value/1e3)}else console.error("Directions Service failed with status:",c),t("Distance calculation failed. Please check the PIN codes.")})})}catch(s){console.error("Google Maps API failed, using fallback calculation:",s);const r=parseInt(e,10),t=parseInt(a,10),i=Math.abs(r-t)/100;return Promise.resolve(i)}}getWeightCharge(e){return e<=5?this.weightCharges["0-5"]:e<=10?this.weightCharges["5-10"]:e<=20?this.weightCharges["10-20"]:this.weightCharges["20+"]}}class E{constructor(e=10,a=6e4){this.maxRequests=e,this.timeWindow=a,this.requests=new Map}isAllowed(e){const a=Date.now(),r=(this.requests.get(e)||[]).filter(t=>a-t<this.timeWindow);return r.length>=this.maxRequests?!1:(r.push(a),this.requests.set(e,r),!0)}handleRequest(e,a){return this.isAllowed(e)?(a(),!0):(typeof ErrorHandler<"u"&&ErrorHandler.show?ErrorHandler.show("Too many requests. Please wait a moment.","warning"):alert("Too many requests. Please wait a moment."),!1)}}let l=class{static show(e,a="info"){const s=document.createElement("div");s.className=`toast toast-${a}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},100),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove())},3e3)}static handleFirebaseError(e){console.error("Firebase Error:",e.code,e.message);const s={"auth/user-not-found":"No account found with this email. Please check your credentials or sign up.","auth/wrong-password":"Incorrect password. Please try again.","auth/email-already-in-use":"This email is already registered. Please log in.","auth/invalid-email":"The email address is not valid.","auth/weak-password":"The password is too weak. It must be at least 6 characters long.","auth/requires-recent-login":"This action is sensitive and requires recent authentication. Please log in again.","permission-denied":"You do not have permission to perform this action.","not-found":"The requested data could not be found.",unavailable:"The service is currently unavailable. Please try again later."}[e.code]||"An unexpected error occurred. Please try again.";this.show(s,"error")}},h=100;document.addEventListener("DOMContentLoaded",()=>{const d=new I,e=new P,a=new E(5,6e4);g(m,async t=>{if(t)try{const n=p(u,"users",t.uid),i=await w(n);if(i.exists()){const c=i.data();document.getElementById("sender-name").value=c.name||"",t.phoneNumber&&(document.getElementById("sender-mobile").value=t.phoneNumber.startsWith("+91")?t.phoneNumber.slice(3):t.phoneNumber),document.getElementById("sender-address").value=c.address||"",document.getElementById("sender-pincode").value=c.pincode||""}}catch(n){l.handleFirebaseError(n)}else l.show("You must be logged in to book a parcel.","error"),setTimeout(()=>{window.location.href="login.html"},2e3)});const s=document.getElementById("parcel-size");s&&s.addEventListener("input",t=>t.target.value=t.target.value.replace(/[ .,]/g,"×")),document.getElementById("calculate-price-button").addEventListener("click",async()=>{if(!d){l.show("Price calculator is not ready yet. Please wait a moment for Google Maps to load.","warning");return}const t=document.getElementById("sender-pincode").value,n=document.getElementById("receiver-pincode").value,i=parseFloat(document.getElementById("parcel-weight").value);if(!t||!n||!i){l.show("Please enter Sender & Receiver PIN codes and Parcel Weight to calculate the price.","warning");return}const c=document.getElementById("price-breakdown");c.innerHTML="Calculating...";try{const o=await d.calculatePrice(t,n,i);o&&o.total?(c.innerHTML=`
                    <p>Distance: ${o.distance} km</p>
                    <p>Base Price: ₹${o.basePrice}</p>
                    <p>GST (18%): ₹${o.gst}</p>
                    <h4 class="font-bold">Total: ₹${o.total}</h4>
                `,h=parseFloat(o.total)):(c.innerHTML="Could not calculate price.",l.show("Could not calculate price. Please check PIN codes.","error"))}catch(o){c.innerHTML="Error in price calculation.",l.show(o.message||"An error occurred during price calculation.","error")}}),document.getElementById("booking-form").addEventListener("submit",function(t){t.preventDefault();const n=m.currentUser;if(!n){l.show("You must be logged in to book a parcel.","error");return}a.handleRequest(n.uid,async()=>{const i=b.sanitizeInput(document.getElementById("sender-name").value),c=document.getElementById("sender-mobile").value,o={userId:n.uid,bookingId:`KS-${Date.now()}`,senderDetails:{name:i,mobile:c},bookingDate:y(),status:"Booked",amount:h,paymentMethod:document.querySelector('input[name="payment"]:checked').value,paymentStatus:"pending"};o.paymentMethod==="online"?await e.initiatePayment(o,r):(o.paymentStatus="cos",await r(o))})});async function r(t){try{const n=f(u,"bookings"),i=await v(n,t);l.show(`Booking successful! Your Booking ID is ${t.bookingId}`,"success"),setTimeout(()=>{window.location.href="dashboard.html"},3e3)}catch(n){l.handleFirebaseError(n)}}});
